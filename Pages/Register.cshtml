@page
@model AceJobAgency.Pages.RegisterModel
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Register";
}

<style>
    :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
        --bg-light: #f8fafc;
        --text-dark: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
    }

    body {
        background-color: var(--bg-light);
    }

    .register-container {
        max-width: 640px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .register-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        padding: 2.5rem;
    }

    .register-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .register-header .logo {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .register-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .register-header p {
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .form-floating {
        margin-bottom: 1rem;
    }

    .form-floating > .form-control,
    .form-floating > .form-select {
        border-radius: 10px;
        border: 2px solid var(--border-color);
        padding: 1rem 0.75rem;
        height: auto;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-floating > .form-control:focus,
    .form-floating > .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-floating > label {
        padding: 1rem 0.75rem;
        color: var(--text-muted);
    }

    .form-control.is-valid {
        border-color: var(--success);
        background-image: none;
    }

    .form-control.is-invalid {
        border-color: var(--error);
        background-image: none;
    }

    .validation-message {
        font-size: 0.8rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .validation-message.error {
        color: var(--error);
    }

    .validation-message.success {
        color: var(--success);
    }

    /* Gender Radio Buttons */
    .gender-options {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .gender-option {
        flex: 1;
    }

    .gender-option input[type="radio"] {
        display: none;
    }

    .gender-option label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        color: var(--text-muted);
    }

    .gender-option input[type="radio"]:checked + label {
        border-color: var(--primary);
        background-color: rgba(37, 99, 235, 0.05);
        color: var(--primary);
    }

    .gender-option label:hover {
        border-color: var(--primary);
    }

    /* Password Strength Meter */
    .password-wrapper {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        z-index: 10;
    }

    .password-strength {
        margin-top: 0.75rem;
    }

    .strength-bars {
        display: flex;
        gap: 4px;
        margin-bottom: 0.5rem;
    }

    .strength-bar {
        height: 4px;
        flex: 1;
        background-color: var(--border-color);
        border-radius: 2px;
        transition: background-color 0.3s;
    }

    .strength-bar.active.weak { background-color: var(--error); }
    .strength-bar.active.medium { background-color: var(--warning); }
    .strength-bar.active.strong { background-color: var(--success); }

    .strength-text {
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .strength-text.weak { color: var(--error); }
    .strength-text.medium { color: var(--warning); }
    .strength-text.strong { color: var(--success); }

    .password-requirements {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.25rem 1rem;
    }

    .requirement {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .requirement .icon {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        flex-shrink: 0;
    }

    .requirement.met .icon {
        background-color: var(--success);
        color: white;
    }

    .requirement.unmet .icon {
        background-color: var(--border-color);
        color: var(--text-muted);
    }

    .requirement.met {
        color: var(--success);
    }

    /* File Upload Zone */
    .file-upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background-color: var(--bg-light);
    }

    .file-upload-zone:hover,
    .file-upload-zone.dragover {
        border-color: var(--primary);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .file-upload-zone .upload-icon {
        width: 48px;
        height: 48px;
        background-color: rgba(37, 99, 235, 0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: var(--primary);
    }

    .file-upload-zone p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .file-upload-zone .browse-link {
        color: var(--primary);
        font-weight: 500;
        text-decoration: none;
    }

    .file-upload-zone .file-types {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        color: var(--text-muted);
    }

    .file-preview {
        display: none;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background-color: rgba(16, 185, 129, 0.1);
        border-radius: 10px;
        margin-top: 0.75rem;
    }

    .file-preview.show {
        display: flex;
    }

    .file-preview .file-icon {
        width: 40px;
        height: 40px;
        background-color: var(--success);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .file-preview .file-info {
        flex: 1;
    }

    .file-preview .file-name {
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .file-preview .file-size {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .file-preview .remove-file {
        background: none;
        border: none;
        color: var(--error);
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Textarea */
    .char-counter {
        text-align: right;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    /* Info Tooltip */
    .info-tooltip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background-color: var(--border-color);
        border-radius: 50%;
        font-size: 0.65rem;
        color: var(--text-muted);
        cursor: help;
        margin-left: 0.25rem;
    }

    /* Submit Button */
    .btn-register {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
        color: white;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-register:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-register:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-register .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .btn-register.loading .spinner {
        display: block;
    }

    .btn-register.loading .btn-text {
        display: none;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .login-link {
        text-align: center;
        margin-top: 1.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .login-link a {
        color: var(--primary);
        font-weight: 500;
        text-decoration: none;
    }

    .login-link a:hover {
        text-decoration: underline;
    }

    .security-note {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 8px;
        color: #059669;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Server-side validation summary */
    .validation-summary {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--error);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .validation-summary ul {
        margin: 0;
        padding-left: 1.25rem;
        color: var(--error);
        font-size: 0.9rem;
    }

    /* Responsive */
    @@media (max-width: 640px) {
        .register-card {
            padding: 1.5rem;
        }

        .password-requirements {
            grid-template-columns: 1fr;
        }

        .row > .col-md-6:first-child {
            margin-bottom: 1rem;
        }
    }
</style>

<div class="register-container">
    <div class="register-card">
        <!-- Header -->
        <div class="register-header">
            <div class="logo">AJ</div>
            <h1>Ace Job Agency</h1>
            <p>Create your membership account</p>
        </div>

        <!-- Validation Summary for Server-Side Errors -->
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="validation-summary">
                <ul>
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }

        <form method="post" enctype="multipart/form-data" id="registerForm" novalidate>
            @Html.AntiForgeryToken()

            <!-- Personal Information Section -->
            <div class="form-section">
                <div class="form-section-title">Personal Information</div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="firstName" name="Input.FirstName"
                                   asp-for="Input.FirstName" placeholder="First Name" required>
                            <label for="firstName">First Name</label>
                            <span asp-validation-for="Input.FirstName" class="validation-message error"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="lastName" name="Input.LastName"
                                   asp-for="Input.LastName" placeholder="Last Name" required>
                            <label for="lastName">Last Name</label>
                            <span asp-validation-for="Input.LastName" class="validation-message error"></span>
                        </div>
                    </div>
                </div>

                <label class="form-label text-muted small mb-2">Gender</label>
                <div class="gender-options">
                    <div class="gender-option">
                        <input type="radio" id="genderMale" name="Input.Gender" value="Male" checked>
                        <label for="genderMale">Male</label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" id="genderFemale" name="Input.Gender" value="Female">
                        <label for="genderFemale">Female</label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" id="genderOther" name="Input.Gender" value="Other">
                        <label for="genderOther">Other</label>
                    </div>
                </div>

                <div class="form-floating">
                    <input type="date" class="form-control" id="dateOfBirth" name="Input.DateOfBirth"
                           asp-for="Input.DateOfBirth" required max="@DateTime.Now.AddYears(-16).ToString("yyyy-MM-dd")">
                    <label for="dateOfBirth">Date of Birth</label>
                    <span asp-validation-for="Input.DateOfBirth" class="validation-message error"></span>
                </div>
            </div>

            <!-- Identity & Contact Section -->
            <div class="form-section">
                <div class="form-section-title">Identity & Contact</div>

                <div class="form-floating">
                    <input type="text" class="form-control" id="nric" name="Input.NRIC"
                           asp-for="Input.NRIC" placeholder="NRIC" required
                           pattern="[STFG]\d{7}[A-Z]" maxlength="9">
                    <label for="nric">
                        NRIC
                        <span class="info-tooltip" data-bs-toggle="tooltip"
                              title="Your NRIC will be encrypted and stored securely">?</span>
                    </label>
                    <span asp-validation-for="Input.NRIC" class="validation-message error"></span>
                </div>

                <div class="form-floating">
                    <input type="email" class="form-control" id="email" name="Input.Email"
                           asp-for="Input.Email" placeholder="Email Address" required>
                    <label for="email">Email Address</label>
                    <span asp-validation-for="Input.Email" class="validation-message error"></span>
                </div>
            </div>

            <!-- Security Section -->
            <div class="form-section">
                <div class="form-section-title">Security</div>

                <div class="password-wrapper">
                    <div class="form-floating">
                        <input type="password" class="form-control" id="password" name="Input.Password"
                               asp-for="Input.Password" placeholder="Password" required>
                        <label for="password">Password</label>
                        <button type="button" class="password-toggle" onclick="togglePassword('password', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bars">
                            <div class="strength-bar" id="bar1"></div>
                            <div class="strength-bar" id="bar2"></div>
                            <div class="strength-bar" id="bar3"></div>
                            <div class="strength-bar" id="bar4"></div>
                        </div>
                        <div class="strength-text" id="strengthText"></div>
                        <div class="password-requirements">
                            <div class="requirement unmet" id="req-length">
                                <span class="icon">&#10003;</span>
                                <span>At least 12 characters</span>
                            </div>
                            <div class="requirement unmet" id="req-upper">
                                <span class="icon">&#10003;</span>
                                <span>Uppercase letter</span>
                            </div>
                            <div class="requirement unmet" id="req-lower">
                                <span class="icon">&#10003;</span>
                                <span>Lowercase letter</span>
                            </div>
                            <div class="requirement unmet" id="req-number">
                                <span class="icon">&#10003;</span>
                                <span>Number</span>
                            </div>
                            <div class="requirement unmet" id="req-special">
                                <span class="icon">&#10003;</span>
                                <span>Special character (!#$%^&amp;*)</span>
                            </div>
                        </div>
                    </div>
                    <span asp-validation-for="Input.Password" class="validation-message error"></span>
                </div>

                <div class="password-wrapper mt-3">
                    <div class="form-floating">
                        <input type="password" class="form-control" id="confirmPassword" name="Input.ConfirmPassword"
                               asp-for="Input.ConfirmPassword" placeholder="Confirm Password" required>
                        <label for="confirmPassword">Confirm Password</label>
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div class="validation-message" id="passwordMatch">
                        <i class="bi" id="matchIcon"></i>
                        <span id="matchText"></span>
                    </div>
                    <span asp-validation-for="Input.ConfirmPassword" class="validation-message error"></span>
                </div>
            </div>

            <!-- Additional Info Section -->
            <div class="form-section">
                <div class="form-section-title">Additional Information</div>

                <label class="form-label text-muted small mb-2">Resume (PDF or DOCX, max 5MB)</label>
                <div class="file-upload-zone" id="dropZone" onclick="document.getElementById('resume').click()">
                    <div class="upload-icon">
                        <i class="bi bi-cloud-arrow-up fs-4"></i>
                    </div>
                    <p>Drag your resume here or <span class="browse-link">browse</span></p>
                    <p class="file-types">Accepted formats: .pdf, .docx</p>
                </div>
                <input type="file" id="resume" name="Input.Resume" accept=".pdf,.docx"
                       style="display: none;" asp-for="Input.Resume">
                <div class="file-preview" id="filePreview">
                    <div class="file-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <button type="button" class="remove-file" onclick="removeFile()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.Resume" class="validation-message error"></span>

                <div class="form-floating mt-3">
                    <textarea class="form-control" id="whoAmI" name="Input.WhoAmI"
                              asp-for="Input.WhoAmI" placeholder="Tell us about yourself"
                              style="height: 120px" maxlength="500"></textarea>
                    <label for="whoAmI">Who Am I (Tell us about yourself)</label>
                    <div class="char-counter"><span id="charCount">0</span>/500 characters</div>
                    <span asp-validation-for="Input.WhoAmI" class="validation-message error"></span>
                </div>
            </div>

            <!-- reCAPTCHA v3 hidden token -->
            <input type="hidden" id="recaptchaToken" name="RecaptchaToken" />

            <!-- Submit Button -->
            <button type="submit" class="btn-register" id="submitBtn">
                <span class="spinner"></span>
                <span class="btn-text">Create Account</span>
            </button>

            <div class="login-link">
                Already have an account? <a href="/Login">Sign in</a>
            </div>

            <div class="security-note">
                <i class="bi bi-shield-check"></i>
                We encrypt your NRIC and protect your account with strong passwords, 2FA and reCAPTCHA.
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <partial name="_ValidationScriptsPartial" />

    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=@Configuration["Recaptcha:SiteKey"]"></script>

    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Password visibility toggle
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }

        // Password strength checker - From Practical 2
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');

        passwordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);

        function checkPasswordStrength(password) {
            const requirements = {
                length: password.length >= 12,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@@#$%^&*]/.test(password)
            };

            // Update requirement indicators
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-upper', requirements.upper);
            updateRequirement('req-lower', requirements.lower);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);

            // Calculate score (0-5)
            let score = Object.values(requirements).filter(Boolean).length;

            // Update strength bars and text
            const bars = [document.getElementById('bar1'), document.getElementById('bar2'),
                         document.getElementById('bar3'), document.getElementById('bar4')];
            const strengthText = document.getElementById('strengthText');

            // Reset bars
            bars.forEach(bar => {
                bar.className = 'strength-bar';
            });

            let strengthClass = '';
            let strengthLabel = '';

            if (password.length === 0) {
                strengthText.textContent = '';
                strengthText.className = 'strength-text';
                return;
            }

            if (score <= 2) {
                strengthClass = 'weak';
                strengthLabel = 'Weak - Please add more complexity';
                bars[0].classList.add('active', 'weak');
            } else if (score === 3) {
                strengthClass = 'medium';
                strengthLabel = 'Medium - Almost there';
                bars[0].classList.add('active', 'medium');
                bars[1].classList.add('active', 'medium');
            } else if (score === 4) {
                strengthClass = 'medium';
                strengthLabel = 'Good - One more requirement';
                bars[0].classList.add('active', 'medium');
                bars[1].classList.add('active', 'medium');
                bars[2].classList.add('active', 'medium');
            } else if (score === 5) {
                strengthClass = 'strong';
                strengthLabel = 'Strong - Excellent password!';
                bars.forEach(bar => bar.classList.add('active', 'strong'));
            }

            strengthText.textContent = strengthLabel;
            strengthText.className = 'strength-text ' + strengthClass;

            // Add visual feedback to password field
            if (score === 5) {
                passwordInput.classList.remove('is-invalid');
                passwordInput.classList.add('is-valid');
            } else {
                passwordInput.classList.remove('is-valid');
                if (password.length > 0) {
                    passwordInput.classList.add('is-invalid');
                }
            }
        }

        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (met) {
                element.classList.remove('unmet');
                element.classList.add('met');
            } else {
                element.classList.remove('met');
                element.classList.add('unmet');
            }
        }

        function checkPasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const matchDiv = document.getElementById('passwordMatch');
            const matchIcon = document.getElementById('matchIcon');
            const matchText = document.getElementById('matchText');

            if (confirmPassword.length === 0) {
                matchText.textContent = '';
                matchIcon.className = 'bi';
                matchDiv.className = 'validation-message';
                confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
                return;
            }

            if (password === confirmPassword) {
                matchIcon.className = 'bi bi-check-circle';
                matchText.textContent = 'Passwords match';
                matchDiv.className = 'validation-message success';
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
            } else {
                matchIcon.className = 'bi bi-x-circle';
                matchText.textContent = 'Passwords do not match';
                matchDiv.className = 'validation-message error';
                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');
            }
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('resume');
        const filePreview = document.getElementById('filePreview');
        const maxFileSize = 5 * 1024 * 1024; // 5MB

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() { dropZone.classList.add('dragover'); }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, function() { dropZone.classList.remove('dragover'); }, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            const validExtensions = ['.pdf', '.docx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!validExtensions.includes(fileExtension)) {
                alert('Please upload a PDF or DOCX file only.');
                fileInput.value = '';
                return;
            }

            if (file.size > maxFileSize) {
                alert('File size must be less than 5MB.');
                fileInput.value = '';
                return;
            }

            // Show file preview using safe textContent
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            filePreview.classList.add('show');
            dropZone.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile() {
            fileInput.value = '';
            filePreview.classList.remove('show');
            dropZone.style.display = 'block';
        }

        // Character counter for "Who Am I"
        const whoAmITextarea = document.getElementById('whoAmI');
        const charCount = document.getElementById('charCount');

        whoAmITextarea.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });

        // Email validation visual feedback
        const emailInput = document.getElementById('email');
        emailInput.addEventListener('blur', function() {
            const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            if (this.value.length > 0) {
                if (emailRegex.test(this.value)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            }
        });

        // Form submission with loading state and reCAPTCHA
        const form = document.getElementById('registerForm');
        const submitBtn = document.getElementById('submitBtn');
        const recaptchaSiteKey = '@Configuration["Recaptcha:SiteKey"]';

        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default submission - we'll submit after reCAPTCHA

            // Client-side validation
            const password = passwordInput.value;
            const regex = /(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@@#$%^&*]).{12,}/;

            if (!regex.test(password)) {
                alert('Password must be at least 12 characters with uppercase, lowercase, number, and special character.');
                return;
            }

            if (password !== confirmPasswordInput.value) {
                alert('Passwords do not match.');
                return;
            }

            // Show loading state
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            // Execute reCAPTCHA v3 and get token
            if (recaptchaSiteKey && recaptchaSiteKey !== 'YOUR_SITE_KEY_HERE') {
                grecaptcha.ready(function() {
                    grecaptcha.execute(recaptchaSiteKey, { action: 'register' })
                        .then(function(token) {
                            document.getElementById('recaptchaToken').value = token;
                            form.submit(); // Now submit the form
                        })
                        .catch(function(error) {
                            console.error('reCAPTCHA error:', error);
                            submitBtn.classList.remove('loading');
                            submitBtn.disabled = false;
                            alert('reCAPTCHA verification failed. Please try again.');
                        });
                });
            } else {
                // reCAPTCHA not configured - submit without token (for development)
                form.submit();
            }
        });

        // NRIC format helper - auto uppercase
        const nricInput = document.getElementById('nric');
        nricInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
}
